@if (loading()) {
  <div class="product-loading">
    <div class="container">Carregando produto...</div>
  </div>
} @else if (error() || !product()) {
  <div class="product-error container">
    <p>Produto não encontrado.</p>
    <a routerLink="/loja" class="btn btn--primary">Voltar para a Loja</a>
  </div>
} @else {
  @let p = product()!;
  <div class="product-page">
    <div class="container">

      <nav class="product-page__breadcrumb">
        <a routerLink="/loja">Loja</a>
        <span>/</span>
        <span>{{ p.name }}</span>
      </nav>

      <div class="product-page__layout">

        <!-- Galeria -->
        <div class="product-gallery">
          <div class="product-gallery__main">
            @if (getMainImage()) {
              <img [src]="getMainImage()" [alt]="p.name" />
            } @else {
              <div class="product-gallery__placeholder">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.75">
                  <rect x="3" y="3" width="18" height="18" rx="1"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <polyline points="21 15 16 10 5 21"/>
                </svg>
              </div>
            }
            @if (p.on_sale) {
              <span class="product-gallery__badge">Sale</span>
            }
          </div>

          @if (p.images.length > 1) {
            <div class="product-gallery__thumbs">
              @for (img of p.images; track img.src; let i = $index) {
                <button
                  class="product-gallery__thumb"
                  [class.active]="selectedImage() === i"
                  (click)="selectedImage.set(i)"
                >
                  <img [src]="img.src" [alt]="img.alt || p.name" />
                </button>
              }
            </div>
          }
        </div>

        <!-- Info -->
        <div class="product-info">
          <h1 class="product-info__name">{{ p.name }}</h1>

          <div class="product-info__pricing">
            <div class="product-info__price-row">
              @if (p.on_sale && p.regular_price) {
                <span class="product-info__price-old">R$ {{ p.regular_price }}</span>
              }
              <span class="product-info__price">R$ {{ p.price }}</span>
            </div>
            <span class="product-info__installment">3x de R$ {{ installment(p.price) }}</span>
          </div>

          @if (p.short_description) {
            <p class="product-info__desc">{{ stripHtml(p.short_description) }}</p>
          }

          @if (getSizes().length) {
            <div class="product-info__sizes">
              <p class="product-info__label">Tamanho</p>
              <div class="product-info__size-grid">
                @for (s of getSizes(); track s) {
                  <button
                    class="size-btn"
                    [class.active]="selectedSize() === s"
                    (click)="selectSize(s)"
                  >
                    {{ s }}
                  </button>
                }
              </div>
            </div>
          }

          <div class="product-info__actions">
            <button
              class="btn btn--primary product-info__add"
              [disabled]="getSizes().length > 0 && !selectedSize()"
              (click)="addToCart()"
            >
              @if (addedToCart()) {
                Adicionado!
              } @else if (getSizes().length > 0 && !selectedSize()) {
                Selecione um tamanho
              } @else {
                Adicionar ao carrinho
              }
            </button>
            @if (isInCart()) {
              <a routerLink="/carrinho" class="btn btn--secondary product-info__cart-link">
                Ver carrinho
              </a>
            }
          </div>

          @if (p.stock_status === 'outofstock') {
            <p class="product-info__out-of-stock">Produto esgotado</p>
          }

          @if (p.description) {
            <div class="product-info__full-desc">
              <p class="product-info__label">Descrição</p>
              <p>{{ stripHtml(p.description) }}</p>
            </div>
          }
        </div>

      </div>
    </div>
  </div>
}
